<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<html>

    <body>

        <menu>

            <button class='navigate left' onclick="app.backOnClick()">
                <svg width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 0C6.55228 0 7 0.447715 7 1V8.58579L10.2929 5.29289C10.6834 4.90237 11.3166 4.90237 11.7071 5.29289C12.0976 5.68342 12.0976 6.31658 11.7071 6.70711L6.70711 11.7071C6.31658 12.0976 5.68342 12.0976 5.29289 11.7071L0.292893 6.70711C-0.0976311 6.31658 -0.0976311 5.68342 0.292893 5.29289C0.683417 4.90237 1.31658 4.90237 1.70711 5.29289L5 8.58579V1C5 0.447715 5.44772 0 6 0Z"/>
                </svg>
            </button>
            
            <div class='radio'>

                <input 
                    type="radio" 
                    id="morning-radio-option" 
                    name="time-of-day-radio-input" 
                    value="morning"
                    onchange="app.morningEveningOnChange()">
                <label class='toggle' for="morning-radio-option">Morning</label>

                <input 
                    type="radio" 
                    id="evening-radio-option" 
                    name="time-of-day-radio-input" 
                    value="evening"
                    onchange="app.morningEveningOnChange()">
                <label class='toggle' for="evening-radio-option">Evening</label>

                <div class='thumb'></div>
            </div>

            <button class='navigate right' onclick="app.forwardOnClick()">
                <svg width="12" height="12" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 0C6.55228 0 7 0.447715 7 1V8.58579L10.2929 5.29289C10.6834 4.90237 11.3166 4.90237 11.7071 5.29289C12.0976 5.68342 12.0976 6.31658 11.7071 6.70711L6.70711 11.7071C6.31658 12.0976 5.68342 12.0976 5.29289 11.7071L0.292893 6.70711C-0.0976311 6.31658 -0.0976311 5.68342 0.292893 5.29289C0.683417 4.90237 1.31658 4.90237 1.70711 5.29289L5 8.58579V1C5 0.447715 5.44772 0 6 0Z"/>
                </svg>
            </button>

        </menu>

        <h1 id='greeting'></h1>
        <div id='date-chevron-positioner'>
            <select id="date-select" class="select" onchange="app.dateSelectOnChange()" onload="app.dateSelectOnLoad()"></select>
            <div id="date-select-width">
                <div id="date-select-calculate"></div>
            </div>
            <svg id='date-chevron' width="10" height="6" viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg">
                <path d="M0.46967 0.46967C0.762563 0.176777 1.23744 0.176777 1.53033 0.46967L5 3.93934L8.46967 0.46967C8.76256 0.176777 9.23744 0.176777 9.53033 0.46967C9.82322 0.762563 9.82322 1.23744 9.53033 1.53033L5.53033 5.53033C5.23744 5.82322 4.76256 5.82322 4.46967 5.53033L0.46967 1.53033C0.176777 1.23744 0.176777 0.762563 0.46967 0.46967Z"/>
            </svg> 
        </div>

        <p id="no-readings-message" style="display:none">Sunday readings are coming soon.</p>

        <div id="scriptures-section" style="display:none">
            <ul>
                <li><a id="psalm"></a></li>
                <li><a id="old-testament"></a></li>
                <li><a id="new-testament"></a></li>
            </ul>
        </div>

    <div class='actions'>
        <div id="play-all-button" class='action'>
            <a class="primary" id="play-all-button-link">
                <svg width="15" height="16" viewBox="0 0 15 16" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M7.49997 2.51773C5.29083 2.51773 3.49997 4.30859 3.49997 6.51773V8.95832C3.97327 9.16442 4.38712 9.51841 4.66505 9.9998L5.66505 11.7318C6.3554 12.9276 5.94572 14.4566 4.74998 15.1469C3.55425 15.8373 2.02527 15.4276 1.33492 14.2318L0.334927 12.4998C-0.355431 11.3041 0.0542606 9.77508 1.25 9.08473C1.33188 9.03745 1.41533 8.99533 1.49997 8.95827V6.51773C1.49997 3.20402 4.18626 0.517731 7.49997 0.517731C10.8137 0.517731 13.5 3.20402 13.5 6.51773V8.95824C13.5846 8.99531 13.6681 9.03743 13.75 9.08472C14.9457 9.77508 15.3554 11.3041 14.6651 12.4998L13.6651 14.2318C12.9747 15.4276 11.4457 15.8372 10.25 15.1469C9.05426 14.4565 8.64458 12.9275 9.33493 11.7318L10.3349 9.99978C10.6128 9.51841 11.0267 9.16443 11.5 8.95833V6.51773C11.5 4.30859 9.7091 2.51773 7.49997 2.51773ZM2.24999 10.8168C2.01084 10.9549 1.92891 11.2606 2.06698 11.4998L3.06697 13.2318C3.20504 13.471 3.51084 13.5529 3.74998 13.4149C3.98913 13.2768 4.07107 12.971 3.933 12.7318L2.933 10.9998C2.79493 10.7606 2.48914 10.6787 2.24999 10.8168ZM12.067 10.9998C12.205 10.7606 12.5108 10.6787 12.75 10.8168C12.9891 10.9548 13.0711 11.2606 12.933 11.4998L11.933 13.2318C11.7949 13.471 11.4891 13.5529 11.25 13.4148C11.0108 13.2768 10.9289 12.971 11.067 12.7318L12.067 10.9998Z"/>
                </svg>                    
                <div>Play all</div>
            </a> 
            <div class='chevron-positioner'>
                <select id="audio-version-select" onchange="app.audioVersionSelectOnChange()">
                <option value="dolan/msg" selected="selected">MSG</option>
                <option value="mclean/niv">NIV</option>
                <option value="breathe/nlt">NLT</option>
            </select>
            <div id="audio-select-width">
                <div id="audio-select-calculate"></div>
            </div>
            <svg class='chevron' width="10" height="6" viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg">
                <path d="M0.46967 0.46967C0.762563 0.176777 1.23744 0.176777 1.53033 0.46967L5 3.93934L8.46967 0.46967C8.76256 0.176777 9.23744 0.176777 9.53033 0.46967C9.82322 0.762563 9.82322 1.23744 9.53033 1.53033L5.53033 5.53033C5.23744 5.82322 4.76256 5.82322 4.46967 5.53033L0.46967 1.53033C0.176777 1.23744 0.176777 0.762563 0.46967 0.46967Z"/>
            </svg> 
            </div>               
        </div>
    </div>
       
        <div id="read-all-button" class='action emphasis'>
            <a class="primary" id="read-all-button-link">
                <svg width="15" height="14" viewBox="0 0 15 14" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0.91529 0.188765C1.17606 0.000813857 1.51128 -0.0503253 1.81623 0.051324L7.5 1.94591L13.1838 0.051324C13.4887 -0.0503253 13.8239 0.000813857 14.0847 0.188765C14.3455 0.376716 14.5 0.678564 14.5 1.00001V11C14.5 11.4304 14.2246 11.8126 13.8162 11.9487L7.81623 13.9487C7.61096 14.0171 7.38904 14.0171 7.18377 13.9487L1.18377 11.9487C0.77543 11.8126 0.5 11.4304 0.5 11V1.00001C0.5 0.678564 0.654521 0.376716 0.91529 0.188765ZM6.5 3.72077L2.5 2.38743V10.2792L6.5 11.6126V3.72077ZM8.5 11.6126L12.5 10.2792V2.38743L8.5 3.72077V11.6126Z"/>
                </svg>
                <div>Read all</div>
            </a> 
            <div class='chevron-positioner'>
            <select id="reading-version-select"onchange="app.readingVersionSelectOnChange()">
                <option value="NIV" selected="selected">NIV</option>
                <option value="MSG">MSG</option>
                <option value="NLT">NLT</option>
            </select>
            <div id="reading-select-width">
                <div id="reading-select-calculate"></div>
            </div>
            <svg class='chevron' width="10" height="6" viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg">
                <path d="M0.46967 0.46967C0.762563 0.176777 1.23744 0.176777 1.53033 0.46967L5 3.93934L8.46967 0.46967C8.76256 0.176777 9.23744 0.176777 9.53033 0.46967C9.82322 0.762563 9.82322 1.23744 9.53033 1.53033L5.53033 5.53033C5.23744 5.82322 4.76256 5.82322 4.46967 5.53033L0.46967 1.53033C0.176777 1.23744 0.176777 0.762563 0.46967 0.46967Z"/>
            </svg> 
            </div>               
        </div>

        <details>
            <summary>
                <div class='content'>
                    <div class='colophon'>New Zealand Anglican Lectionary</div>
                    <div class='about'></div>
                </div>
            </summary>
            <div class="message">
                Made with aroha in Wellington by Isabel Anastasiadis & Isaac Minogue. Readings taken from the New Zealand Anglican Lectionary and the Church of England.</div>
        </details>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="data.js"></script>
        <script>

            class App {
                
                // control fields
                #data;
                #masterDateKey;
                #morningOrEvening;
                #readingVersion;
                #audioVersion;

                constructor(){
                    this.#data = new Data().getData();
                }

                initialisePage() {

                    // set date to today
                    var now = new Date();
                    this.#masterDateKey =  this.#convertDateToDateKey(now);

                    // work out morning/evening default to show
                    this.#morningOrEvening = this.#checkCurrentTime(now);
                    this.#setRadioOption(this.#morningOrEvening)                

                    // populate the dropdown with all the dates, and select the current one
                    var $dropdown = $("#date-select");
                    Object.keys(this.#data).forEach(date => {
                        var text = this.#data[date].date_pretty;
                        var option = $("<option />").val(date).text(text);
                        $dropdown.append(option);
                        
                    });
                    $(`#date-select option[value="${this.#masterDateKey}"]`).attr("selected",true);
                    
                    // Resize selects to match content
                    this.#resizeDate()
                    this.#resizeAudio()
                    this.#resizeReading()
                    
                    
                    this.#audioVersion = $("#audio-version-select").val();
                    this.#readingVersion = $("#reading-version-select").val();

                    // now fill in the data for the day
                    this.#refreshPageData();
                }


                dateSelectOnChange() {
                    this.#masterDateKey = $("#date-select").val();
                    this.#refreshPageData();
                    this.#resizeDate()
                }

                backOnClick() {
                    this.#masterDateKey = this.#getAdjacentDateKey(this.#masterDateKey, -1);
                    this.#refreshPageData();
                    this.#resizeDate()
                }

                forwardOnClick() {
                    this.#masterDateKey = this.#getAdjacentDateKey(this.#masterDateKey, 1);
                    this.#refreshPageData();
                    this.#resizeDate()
                }

                morningEveningOnChange() {
                    this.#morningOrEvening = $("input[name='time-of-day-radio-input']:checked").val();
                    this.#setRadioOption(this.#morningOrEvening);
                    this.#refreshPageData();
                }

                audioVersionSelectOnChange() {
                    this.#audioVersion = $("#audio-version-select").val();
                    this.#refreshPageData();
                    this.#resizeAudio();
                }

                readingVersionSelectOnChange() {
                    this.#readingVersion = $("#reading-version-select").val();
                    this.#refreshPageData();
                    this.#resizeReading();
                }

                // Private methods
                //----------------------------------------------------------------------------------

                #resizeDate() {
                    // Add extra 20px space to allow for arrow icon
                    $("#date-select-calculate").html($('#date-select option:selected').text());
                    $('#date-select').width($("#date-select-width").width() + 20); 
                }

                #resizeAudio() {
                    $("#audio-select-calculate").html($('#audio-version-select option:selected').text());
                    $('#audio-version-select').width($("#audio-select-width").width()); 
                }

                #resizeReading() {
                    $("#reading-select-calculate").html($('#reading-version-select option:selected').text());
                    $('#reading-version-select').width($("#reading-select-width").width()); 
                }
                
                #checkCurrentTime(date) {
                    // Set morning as 12am - 12pm
                    var hours = date.getHours();
                    var morning = hours >= 0 && hours <= 12;
                    return morning ? "morning" : "evening";
                }

                #refreshPageData() {
                    var todaysData = this.#data[this.#masterDateKey];

                    // select the right date in the dropdown
                    $('#date-select option:selected').attr("selected",false);
                    $(`#date-select option[value="${this.#masterDateKey}"]`).attr("selected",true);
                    
                    // populate the greeting
                    if(this.#morningOrEvening === "morning"){
                        $("#greeting").text("Ata m\u0101rie.");
                    }
                    else {
                        $("#greeting").text("Po m\u0101rie.");
                    }
                    
                    // populate the scripture readings
                    var scriptures = todaysData[this.#morningOrEvening]["readings"];
                    var readingParams = todaysData[this.#morningOrEvening]["reading_link"];
                    var audioParams = todaysData[this.#morningOrEvening]["audio_link"];
                    var readingParamsArray = readingParams.split("%3B+");

                    if(scriptures[0] === ""){ // TODO: change the data to be empty/null, this is kinda weird..
                        $("#no-readings-message").show();
                        $("#scriptures-section").hide();
                        $("#play-all-button").hide();
                        $("#read-all-button").hide();
                    }
                    else {
                        $("#no-readings-message").hide();
                        $("#scriptures-section").show();
                        $("#play-all-button").show();
                        $("#read-all-button").show();

                        $("#psalm").text(scriptures[0]);
                        $("#psalm").attr("href", `https://www.biblegateway.com/passage/?version=${this.#readingVersion}&search=${readingParamsArray[0]}`);

                        $("#old-testament").text(scriptures[1]);
                        $("#old-testament").attr("href", `https://www.biblegateway.com/passage/?version=${this.#readingVersion}&search=${readingParamsArray[1]}`);

                        $("#new-testament").text(scriptures[2]);
                        $("#new-testament").attr("href", `https://www.biblegateway.com/passage/?version=${this.#readingVersion}&search=${readingParamsArray[2]}`);

                        $("#play-all-button-link").attr("href", `https://www.biblegateway.com/audio/${this.#audioVersion}/${audioParams}`);
                        $("#read-all-button-link").attr("href", `https://www.biblegateway.com/passage/?version=${this.#readingVersion}&search=${readingParams}`);
                    }
                }

                #padToTwoDigits(number) {
                    return `0${number}`.slice(-2); // slice here returns the last two characters
                }

                #convertDateToDateKey(date) {
                    var year = date.getFullYear();
                    var month = this.#padToTwoDigits(date.getMonth() + 1); // getMonth is zero based...?
                    var day = this.#padToTwoDigits(date.getDate()); // getDate returns the day of the month...?
                    return `${year}/${month}/${day}`;
                }

                #getAdjacentDateKey(dateKey, numberModifier) {
                    var date = new Date(dateKey.replace(/\//g,'-'));

                    var newDate = new Date();
                    newDate.setDate(date.getDate() + numberModifier);

                    return this.#convertDateToDateKey(newDate);
                }

                #setRadioOption(timeOfDay) {
                    var morningRadioEl = document.querySelector("#morning-radio-option");
                    var eveningRadioEl = document.querySelector("#evening-radio-option");
                    var root = document.querySelector(':root');
                    if (timeOfDay === "morning") {
                        morningRadioEl.checked = true;
                        root.style.setProperty('--foreground', 'rgba(0,0,0,1)');
                        root.style.setProperty('--background', 'rgba(255,255,255,1)');

                        root.style.setProperty('--toggle-base', 'rgba(0,0,0,0.05)');
                        root.style.setProperty('--toggle-stage', 'rgba(0,0,0,0.05)');
                        root.style.setProperty('--toggle-select', 'rgba(0,0,0,0.1)');

                        root.style.setProperty('--toggle-checked-base', 'rgba(0,0,0,1)');
                        root.style.setProperty('--toggle-checked-stage', 'rgba(255,255,255,0.2)');
                        root.style.setProperty('--toggle-checked-select', 'rgba(255,255,255,0.25)');
                    } else {
                        eveningRadioEl.checked = true;
                        root.style.setProperty('--background', 'rgba(0,0,0,1)');
                        root.style.setProperty('--foreground', 'rgba(255,255,255,1)');

                        root.style.setProperty('--toggle-base', 'rgba(255,255,255,0.2)');
                        root.style.setProperty('--toggle-stage', 'rgba(255,255,255,0.05)');
                        root.style.setProperty('--toggle-select', 'rgba(255,255,255,0.1)');

                        root.style.setProperty('--toggle-checked-base', 'rgba(255,255,255,1)');
                        root.style.setProperty('--toggle-checked-stage', 'rgba(0,0,0,0.1)');
                        root.style.setProperty('--toggle-checked-select', 'rgba(0,0,0,0.2)');
                    }
                }

            }

            var app = new App();

            // The script entrypoint (kicks off when jquery is loaded)
            //--------------------------------------------------------
            $(document).ready(function() {
                app.initialisePage();
            });

        </script>

    </body>
</html>